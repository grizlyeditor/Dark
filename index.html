<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VisualHosting</title>
  <!-- Add Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    :root {
      --bg: #1e0c2a;
      --surface: #28113a;
      --primary: #1976d2;
      --text: #ffffff;
      --accent: #ff00cc;
      --success: #00ff00;
      --error: #ff3333;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--primary);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .brand { font-size: 1.5rem; font-weight: bold; }
    .menu-btn {
      font-size: 1.8rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    .menu {
      position: absolute;
      top: 64px;
      right: 24px;
      background: var(--surface);
      border-radius: 10px;
      display: none;
      flex-direction: column;
      min-width: 150px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      z-index: 99;
    }
    .menu a {
      color: white;
      text-decoration: none;
      padding: 12px 16px;
      font-size: 0.95rem;
    }
    .menu a:hover {
      background: rgba(255,255,255,0.1);
    }
    main { flex: 1; padding: 32px; }
    .section { display: none; }
    .section.active { display: block; }
    .auth-form {
      max-width: 400px;
      margin: 0 auto;
      background: var(--surface);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .auth-form h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #444;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .btn {
      padding: 14px 30px;
      border-radius: 50px;
      border: none;
      background: linear-gradient(45deg, var(--accent), var(--primary));
      color: white;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 12px 24px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
      width: 100%;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--primary);
    }
    .console {
      background: #000000;
      color: #00ff00;
      font-family: monospace;
      padding: 20px;
      border-radius: 10px;
      height: 300px;
      overflow-y: auto;
      box-shadow: 0 0 15px #000;
      line-height: 1.4;
      position: relative;
    }
    .cursor {
      display: inline-block;
      width: 10px;
      height: 1em;
      background: #00ff00;
      animation: blink 1s step-start infinite;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .project-card {
      background: var(--surface);
      border-radius: 10px;
      padding: 20px;
      transition: transform 0.2s;
      cursor: pointer;
      position: relative;
    }
    .project-card:hover {
      transform: translateY(-5px);
    }
    .project-card h3 {
      margin-bottom: 10px;
    }
    .project-menu {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .file-actions {
      position: relative;
    }
    .file-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--surface);
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: none;
      z-index: 10;
    }
    .file-menu.show {
      display: block;
    }
    .file-menu-item {
      padding: 8px 15px;
      cursor: pointer;
    }
    .file-menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--surface);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .close-modal {
      font-size: 1.5rem;
      cursor: pointer;
    }
    .error-message {
      color: var(--error);
      margin-top: 5px;
      font-size: 0.9rem;
    }
    .success-message {
      color: var(--success);
      margin-top: 5px;
      font-size: 0.9rem;
    }
    .otp-container {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .otp-input {
      width: 40px;
      height: 40px;
      text-align: center;
      font-size: 1.2rem;
      border-radius: 5px;
      border: 1px solid #444;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .countdown {
      font-size: 1.5rem;
      text-align: center;
      margin: 10px 0;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <header id="app-header" style="display: none;">
    <div class="brand">VisualHosting</div>
    <button class="menu-btn" id="menu-btn">⋮</button>
    <nav class="menu" id="menu">
      <a href="#dashboard" data-page="dashboard">Dashboard</a>
      <a href="#projects" data-page="projects">Projects</a>
      <a href="#files" data-page="files">Files</a>
      <a href="#console" data-page="console">Console</a>
      <a href="#settings" data-page="settings">Settings</a>
      <a href="#logout" data-page="logout">Logout</a>
    </nav>
  </header>
  
  <main id="app-main">
    <!-- Authentication Sections -->
    <div id="auth" class="section active">
      <div class="auth-form" id="signup-form">
        <h2>Create Account</h2>
        <div class="form-group">
          <label for="signup-name">Name</label>
          <input type="text" id="signup-name" placeholder="Enter your name">
        </div>
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="Enter your email">
          <div id="signup-email-error" class="error-message"></div>
        </div>
        <button class="btn" id="signup-btn">Sign Up</button>
        <div id="otp-section" style="display: none;">
          <div class="form-group">
            <label>Enter OTP</label>
            <div class="otp-container">
              <input type="text" class="otp-input" maxlength="1" data-index="0">
              <input type="text" class="otp-input" maxlength="1" data-index="1">
              <input type="text" class="otp-input" maxlength="1" data-index="2">
              <input type="text" class="otp-input" maxlength="1" data-index="3">
              <input type="text" class="otp-input" maxlength="1" data-index="4">
              <input type="text" class="otp-input" maxlength="1" data-index="5">
            </div>
            <div id="otp-error" class="error-message"></div>
          </div>
          <button class="btn" id="verify-otp-btn">Verify OTP</button>
        </div>
        <div id="password-section" style="display: none;">
          <div class="form-group">
            <label for="signup-password">Create Password</label>
            <input type="password" id="signup-password" placeholder="Create a password">
          </div>
          <div class="form-group">
            <label for="signup-confirm-password">Confirm Password</label>
            <input type="password" id="signup-confirm-password" placeholder="Confirm your password">
            <div id="password-error" class="error-message"></div>
          </div>
          <button class="btn" id="complete-signup-btn">Complete Sign Up</button>
        </div>
        <p style="text-align: center; margin-top: 15px;">
          Already have an account? <a href="#" id="show-login">Login</a>
        </p>
      </div>

      <div class="auth-form" id="login-form" style="display: none;">
        <h2>Login</h2>
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="Enter your password">
          <div id="login-error" class="error-message"></div>
        </div>
        <button class="btn" id="login-btn">Login</button>
        <p style="text-align: center; margin-top: 15px;">
          Don't have an account? <a href="#" id="show-signup">Sign Up</a>
        </p>
      </div>
    </div>

    <!-- App Sections (shown after login) -->
    <div id="dashboard" class="section">
      <h1>Welcome to VisualHosting</h1>
      <p>Get started by launching your system or learning more about it.</p>
      <button class="btn" onclick="startTerminal()">Start</button>
      <button class="btn">About</button>
    </div>

    <div id="projects" class="section">
      <h2>My Projects</h2>
      <button class="btn" id="new-project-btn">New Project</button>
      <div class="projects-grid" id="projects-container">
        <!-- Projects will be loaded here -->
      </div>
    </div>

    <div id="files" class="section">
      <h2>My Files</h2>
      <button class="btn" id="upload-file-btn">Upload File</button>
      <input type="file" id="file-input" style="display: none;">
      <div id="files-container" style="margin-top: 20px;">
        <!-- Files will be loaded here -->
      </div>
    </div>

    <div id="console" class="section">
      <button class="btn" onclick="startTerminal()">Start</button>
      <button class="btn" onclick="stopTerminal()">Stop</button>
      <button class="btn" onclick="restartTerminal()">Restart</button>
      <div class="countdown" id="countdown" style="display: none;"></div>
      <div class="console" id="consoleBox"></div>
    </div>

    <div id="settings" class="section">
      <h2>Settings</h2>
      <div class="form-group">
        <label>User ID</label>
        <input type="text" id="user-id-display" readonly>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="text" id="user-email-display" readonly>
      </div>
      <button class="btn btn-secondary" id="change-password-btn">Change Password</button>
    </div>

    <div id="logout" class="section">
      <h2>You have been logged out successfully. 👋</h2>
      <button class="btn" id="go-to-login">Back to Login</button>
    </div>
  </main>

  <!-- Modals -->
  <div class="modal" id="new-project-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Project</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="form-group">
        <label for="project-name">Project Name</label>
        <input type="text" id="project-name" placeholder="Enter project name">
      </div>
      <button class="btn" id="create-project-btn">Create Project</button>
    </div>
  </div>

  <div class="modal" id="file-menu-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>File Actions</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="file-menu-item" id="rename-file-btn">Rename</div>
      <div class="file-menu-item" id="download-file-btn">Download</div>
      <div class="file-menu-item" id="delete-file-btn">Delete</div>
    </div>
  </div>

  <div class="modal" id="rename-file-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rename File</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="form-group">
        <label for="new-file-name">New Name</label>
        <input type="text" id="new-file-name" placeholder="Enter new file name">
      </div>
      <button class="btn" id="confirm-rename-btn">Rename</button>
    </div>
  </div>

  <div class="modal" id="change-password-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Change Password</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="form-group">
        <label for="current-password">Current Password</label>
        <input type="password" id="current-password" placeholder="Enter current password">
      </div>
      <div class="form-group">
        <label for="new-password">New Password</label>
        <input type="password" id="new-password" placeholder="Enter new password">
      </div>
      <div class="form-group">
        <label for="confirm-new-password">Confirm New Password</label>
        <input type="password" id="confirm-new-password" placeholder="Confirm new password">
        <div id="password-change-error" class="error-message"></div>
      </div>
      <button class="btn" id="confirm-password-change-btn">Change Password</button>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBPq0-ASJl4j4Jcm_biv8jABHvtvGqqfsY",
      authDomain: "visualhosting-15c11.firebaseapp.com",
      projectId: "visualhosting-15c11",
      storageBucket: "visualhosting-15c11.appspot.com",
      messagingSenderId: "873151433177",
      appId: "1:873151433177:web:1760149e202d857bd571c8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM Elements
    const appHeader = document.getElementById('app-header');
    const appMain = document.getElementById('app-main');
    const menuBtn = document.getElementById("menu-btn");
    const menu = document.getElementById("menu");
    const sections = document.querySelectorAll('main .section');
    const links = document.querySelectorAll('[data-page]');
    
    // Auth elements
    const signupForm = document.getElementById('signup-form');
    const loginForm = document.getElementById('login-form');
    const showLogin = document.getElementById('show-login');
    const showSignup = document.getElementById('show-signup');
    const signupBtn = document.getElementById('signup-btn');
    const loginBtn = document.getElementById('login-btn');
    const otpSection = document.getElementById('otp-section');
    const passwordSection = document.getElementById('password-section');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    const completeSignupBtn = document.getElementById('complete-signup-btn');
    const goToLoginBtn = document.getElementById('go-to-login');
    
    // Project elements
    const newProjectBtn = document.getElementById('new-project-btn');
    const projectsContainer = document.getElementById('projects-container');
    const newProjectModal = document.getElementById('new-project-modal');
    const createProjectBtn = document.getElementById('create-project-btn');
    
    // File elements
    const uploadFileBtn = document.getElementById('upload-file-btn');
    const fileInput = document.getElementById('file-input');
    const filesContainer = document.getElementById('files-container');
    const fileMenuModal = document.getElementById('file-menu-modal');
    const renameFileModal = document.getElementById('rename-file-modal');
    const confirmRenameBtn = document.getElementById('confirm-rename-btn');
    
    // Settings elements
    const changePasswordBtn = document.getElementById('change-password-btn');
    const changePasswordModal = document.getElementById('change-password-modal');
    const confirmPasswordChangeBtn = document.getElementById('confirm-password-change-btn');
    
    // State variables
    let currentUser = null;
    let currentFile = null;
    let confirmationResult = null;
    let otpInputs = document.querySelectorAll('.otp-input');

    // Event Listeners
    menuBtn.addEventListener("click", () => {
      menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    });

    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && e.target !== menuBtn) {
        menu.style.display = "none";
      }
    });

    links.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = link.dataset.page;
        showSection(page);
        menu.style.display = 'none';
      });
    });

    showLogin.addEventListener('click', (e) => {
      e.preventDefault();
      signupForm.style.display = 'none';
      loginForm.style.display = 'block';
    });

    showSignup.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.style.display = 'none';
      signupForm.style.display = 'block';
    });

    goToLoginBtn.addEventListener('click', () => {
      showSection('auth');
      loginForm.style.display = 'block';
      signupForm.style.display = 'none';
    });

    signupBtn.addEventListener('click', handleSignup);
    verifyOtpBtn.addEventListener('click', verifyOtp);
    completeSignupBtn.addEventListener('click', completeSignup);
    loginBtn.addEventListener('click', handleLogin);
    
    // Project related event listeners
    newProjectBtn.addEventListener('click', () => {
      document.getElementById('project-name').value = '';
      newProjectModal.style.display = 'flex';
    });
    
    createProjectBtn.addEventListener('click', createProject);
    
    // File related event listeners
    uploadFileBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', handleFileUpload);
    
    // Settings related event listeners
    changePasswordBtn.addEventListener('click', () => {
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-new-password').value = '';
      document.getElementById('password-change-error').textContent = '';
      changePasswordModal.style.display = 'flex';
    });
    
    confirmPasswordChangeBtn.addEventListener('click', changePassword);
    
    // Close modals when clicking X
    document.querySelectorAll('.close-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.style.display = 'none';
        });
      });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });
    
    // OTP input handling
    otpInputs.forEach(input => {
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        const index = parseInt(e.target.dataset.index);
        
        if (value.length === 1 && index < otpInputs.length - 1) {
          otpInputs[index + 1].focus();
        }
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && e.target.value === '') {
          const index = parseInt(e.target.dataset.index);
          if (index > 0) {
            otpInputs[index - 1].focus();
          }
        }
      });
    });

    // Check auth state on load
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('user-id-display').value = user.uid;
        document.getElementById('user-email-display').value = user.email;
        appHeader.style.display = 'flex';
        showSection('dashboard');
        loadProjects();
        loadFiles();
      } else {
        currentUser = null;
        appHeader.style.display = 'none';
        showSection('auth');
      }
    });

    // Functions
    function showSection(sectionId) {
      sections.forEach(sec => sec.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      
      if (sectionId === 'projects') {
        loadProjects();
      } else if (sectionId === 'files') {
        loadFiles();
      }
    }

    async function handleSignup() {
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const emailError = document.getElementById('signup-email-error');
      
      if (!email) {
        emailError.textContent = 'Email is required';
        return;
      }
      
      emailError.textContent = '';
      
      try {
        // Check if email already exists
        const methods = await auth.fetchSignInMethodsForEmail(email);
        if (methods.length > 0) {
          emailError.textContent = 'Email already in use';
          return;
        }
        
        // Send OTP
        const appVerifier = new firebase.auth.RecaptchaVerifier('signup-btn', {
          size: 'invisible'
        });
        
        confirmationResult = await auth.signInWithPhoneNumber(email, appVerifier);
        
        // Show OTP section
        signupBtn.style.display = 'none';
        otpSection.style.display = 'block';
      } catch (error) {
        emailError.textContent = error.message;
      }
    }

    async function verifyOtp() {
      const otpError = document.getElementById('otp-error');
      otpError.textContent = '';
      
      let otp = '';
      otpInputs.forEach(input => {
        otp += input.value;
      });
      
      if (otp.length !== 6) {
        otpError.textContent = 'Please enter a 6-digit OTP';
        return;
      }
      
      try {
        await confirmationResult.confirm(otp);
        
        // Show password section
        otpSection.style.display = 'none';
        passwordSection.style.display = 'block';
      } catch (error) {
        otpError.textContent = 'Invalid OTP';
      }
    }

    async function completeSignup() {
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('signup-confirm-password').value;
      const passwordError = document.getElementById('password-error');
      
      if (password !== confirmPassword) {
        passwordError.textContent = 'Passwords do not match';
        return;
      }
      
      if (password.length < 6) {
        passwordError.textContent = 'Password must be at least 6 characters';
        return;
      }
      
      passwordError.textContent = '';
      
      try {
        // Create user with email and password
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Save additional user data
        await db.collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Show success message and redirect
        showSection('dashboard');
      } catch (error) {
        passwordError.textContent = error.message;
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const loginError = document.getElementById('login-error');
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        // Auth state listener will handle the redirect
      } catch (error) {
        loginError.textContent = error.message;
      }
    }

    async function loadProjects() {
      if (!currentUser) return;
      
      try {
        const snapshot = await db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .get();
        
        projectsContainer.innerHTML = '';
        
        if (snapshot.empty) {
          projectsContainer.innerHTML = '<p>No projects found. Create your first project!</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const project = doc.data();
          const projectCard = document.createElement('div');
          projectCard.className = 'project-card';
          projectCard.innerHTML = `
            <div class="project-menu">⋮</div>
            <h3>${project.name}</h3>
            <p>Created: ${new Date(project.createdAt.toDate()).toLocaleDateString()}</p>
          `;
          projectsContainer.appendChild(projectCard);
        });
      } catch (error) {
        console.error('Error loading projects:', error);
      }
    }

    async function createProject() {
      const name = document.getElementById('project-name').value;
      
      if (!name) return;
      
      try {
        await db.collection('projects').add({
          name: name,
          userId: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        newProjectModal.style.display = 'none';
        loadProjects();
      } catch (error) {
        console.error('Error creating project:', error);
      }
    }

    async function loadFiles() {
      if (!currentUser) return;
      
      try {
        const storageRef = storage.ref(`users/${currentUser.uid}`);
        const files = await storageRef.listAll();
        
        filesContainer.innerHTML = '';
        
        if (files.items.length === 0) {
          filesContainer.innerHTML = '<p>No files found. Upload your first file!</p>';
          return;
        }
        
        files.items.forEach(async (item) => {
          const metadata = await item.getMetadata();
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span>${metadata.name}</span>
            <div class="file-actions">
              <span class="file-menu-btn">⋮</span>
            </div>
          `;
          
          const menuBtn = fileItem.querySelector('.file-menu-btn');
          menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentFile = item;
            fileMenuModal.style.display = 'flex';
          });
          
          filesContainer.appendChild(fileItem);
        });
      } catch (error) {
        console.error('Error loading files:', error);
      }
    }

    async function handleFileUpload() {
      const file = fileInput.files[0];
      
      if (!file) return;
      
      try {
        const storageRef = storage.ref(`users/${currentUser.uid}/${file.name}`);
        await storageRef.put(file);
        loadFiles();
      } catch (error) {
        console.error('Error uploading file:', error);
      }
    }

    async function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmNewPassword = document.getElementById('confirm-new-password').value;
      const errorElement = document.getElementById('password-change-error');
      
      if (newPassword !== confirmNewPassword) {
        errorElement.textContent = 'New passwords do not match';
        return;
      }
      
      if (newPassword.length < 6) {
        errorElement.textContent = 'Password must be at least 6 characters';
        return;
      }
      
      try {
        // Reauthenticate user
        const credential = firebase.auth.EmailAuthProvider.credential(
          currentUser.email, 
          currentPassword
        );
        
        await currentUser.reauthenticateWithCredential(credential);
        
        // Change password
        await currentUser.updatePassword(newPassword);
        
        // Show success and close modal
        errorElement.textContent = '';
        errorElement.classList.add('success-message');
        errorElement.textContent = 'Password changed successfully!';
        
        setTimeout(() => {
          changePasswordModal.style.display = 'none';
          errorElement.classList.remove('success-message');
          errorElement.textContent = '';
        }, 2000);
      } catch (error) {
        errorElement.textContent = error.message;
      }
    }

    // Console functions
    function startTerminal() {
      const consoleBox = document.getElementById("consoleBox");
      const countdown = document.getElementById("countdown");
      consoleBox.innerHTML = "";
      countdown.style.display = "block";
      
      let timeLeft = 5;
      countdown.textContent = `Starting in ${timeLeft} seconds...`;
      
      const countdownInterval = setInterval(() => {
        timeLeft--;
        countdown.textContent = `Starting in ${timeLeft} seconds...`;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          countdown.style.display = "none";
          runTerminal();
        }
      }, 1000);
    }

    function runTerminal() {
      const consoleBox = document.getElementById("consoleBox");
      consoleBox.innerHTML = "";
      const commands = [
        "user@visual:~$ booting system...",
        "user@visual:~$ initializing modules...",
        "user@visual:~$ checking dependencies...",
        "user@visual:~$ downloading required files...",
        "user@visual:~$ verifying installation...",
        "user@visual:~$ running VisualHostX terminal...",
        "user@visual:~$ BPT successfully started.\n"
      ];
      
      let i = 0;
      function typeLine(line, callback) {
        let index = 0;
        const typing = setInterval(() => {
          if (index < line.length) {
            consoleBox.innerHTML += line.charAt(index);
            index++;
            consoleBox.scrollTop = consoleBox.scrollHeight;
          } else {
            clearInterval(typing);
            consoleBox.innerHTML += '<br>';
            if (callback) callback();
          }
        }, 20);
      }
      
      function next() {
        if (i < commands.length) {
          typeLine(commands[i], () => {
            i++;
            next();
          });
        } else {
          // Start live updates
          startLiveUpdates();
        }
      }
      
      next();
    }

    function startLiveUpdates() {
      const consoleBox = document.getElementById("consoleBox");
      const liveCommands = [
        "user@visual:~$ checking system status... OK",
        "user@visual:~$ memory usage: 45%",
        "user@visual:~$ cpu load: 23%",
        "user@visual:~$ network: active (12.5 MB/s)",
        "user@visual:~$ storage: 128GB/500GB",
        "user@visual:~$ running processes: 12"
      ];
      
      let i = 0;
      const liveInterval = setInterval(() => {
        if (i < liveCommands.length) {
          consoleBox.innerHTML += liveCommands[i] + '<br>';
          consoleBox.scrollTop = consoleBox.scrollHeight;
          i++;
        } else {
          // Rotate through commands
          i = 0;
        }
      }, 3000);
      
      // Store interval ID so we can clear it later
      consoleBox.dataset.liveInterval = liveInterval;
    }

    function stopTerminal() {
      const consoleBox = document.getElementById("consoleBox");
      const countdown = document.getElementById("countdown");
      
      // Clear any live updates
      if (consoleBox.dataset.liveInterval) {
        clearInterval(parseInt(consoleBox.dataset.liveInterval));
      }
      
      countdown.style.display = "block";
      let timeLeft = 3;
      countdown.textContent = `Stopping in ${timeLeft} seconds...`;
      
      const countdownInterval = setInterval(() => {
        timeLeft--;
        countdown.textContent = `Stopping in ${timeLeft} seconds...`;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          countdown.style.display = "none";
          consoleBox.innerHTML += "\nuser@visual:~$ System stopped. ❌<br>";
          consoleBox.innerHTML += "user@visual:~$ <span class='cursor'></span>";
          consoleBox.scrollTop = consoleBox.scrollHeight;
        }
      }, 1000);
    }

    function restartTerminal() {
      const consoleBox = document.getElementById("consoleBox");
      
      // Clear any live updates
      if (consoleBox.dataset.liveInterval) {
        clearInterval(parseInt(consoleBox.dataset.liveInterval));
      }
      
      consoleBox.innerHTML += "user@visual:~$ Restarting system... ♻️<br>";
      setTimeout(() => {
        startTerminal();
      }, 1500);
    }
    
    // Initialize file menu actions
    document.getElementById('rename-file-btn').addEventListener('click', () => {
      fileMenuModal.style.display = 'none';
      document.getElementById('new-file-name').value = currentFile.name.split('/').pop();
      renameFileModal.style.display = 'flex';
    });
    
    document.getElementById('delete-file-btn').addEventListener('click', async () => {
      try {
        await currentFile.delete();
        fileMenuModal.style.display = 'none';
        loadFiles();
      } catch (error) {
        console.error('Error deleting file:', error);
      }
    });
    
    document.getElementById('download-file-btn').addEventListener('click', async () => {
      try {
        const url = await currentFile.getDownloadURL();
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFile.name.split('/').pop();
        a.click();
        fileMenuModal.style.display = 'none';
      } catch (error) {
        console.error('Error downloading file:', error);
      }
    });
    
    confirmRenameBtn.addEventListener('click', async () => {
      const newName = document.getElementById('new-file-name').value;
      
      if (!newName) return;
      
      try {
        // Get the file's current path
        const oldPath = currentFile.fullPath;
        const newPath = oldPath.substring(0, oldPath.lastIndexOf('/') + 1) + newName;
        
        // Copy to new location and delete original
        await currentFile.parent.child(newName).put(await currentFile.getBlob());
        await currentFile.delete();
        
        renameFileModal.style.display = 'none';
        loadFiles();
      } catch (error) {
        console.error('Error renaming file:', error);
      }
    });
  </script>
</body>
</html>